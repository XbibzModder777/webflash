<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP Firmware Flasher</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4285f4;
            --primary-dark: #3367d6;
            --secondary: #34a853;
            --danger: #ea4335;
            --warning: #fbbc05;
            --text: #202124;
            --text-secondary: #5f6368;
            --bg: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e8eaed;
            --border: #dadce0;
            --card-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 2px 6px 2px rgba(60,64,67,0.15);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        [data-theme="dark"] {
            --primary: #8ab4f8;
            --primary-dark: #7aa7f7;
            --secondary: #81c995;
            --danger: #f28b82;
            --warning: #fde293;
            --text: #e8eaed;
            --text-secondary: #9aa0a6;
            --bg: #121212;
            --bg-secondary: #1e1e1e;
            --bg-tertiary: #2d2d2d;
            --border: #3c4043;
            --card-shadow: 0 1px 3px 0 rgba(0,0,0,0.5), 0 4px 8px 3px rgba(0,0,0,0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            transition: var(--transition);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            flex: 1;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 30px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary);
        }

        .logo i {
            font-size: 2rem;
        }

        .theme-toggle {
            background: none;
            border: none;
            color: var(--text);
            font-size: 1.5rem;
            cursor: pointer;
            transition: var(--transition);
            padding: 5px;
            border-radius: 50%;
        }

        .theme-toggle:hover {
            background-color: var(--bg-tertiary);
        }

        .card {
            background-color: var(--bg-secondary);
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            padding: 25px;
            margin-bottom: 30px;
            transition: var(--transition);
        }

        .card-title {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title i {
            font-size: 1.3rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text);
        }

        select, input, button {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border);
            border-radius: 4px;
            background-color: var(--bg);
            color: var(--text);
            font-size: 1rem;
            transition: var(--transition);
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.9rem;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: #d33426;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #2d9142;
            transform: translateY(-2px);
        }

        .btn-warning {
            background-color: var(--warning);
            color: #202124;
        }

        .btn-warning:hover {
            background-color: #e6ac00;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .progress-container {
            margin-top: 20px;
            display: none;
        }

        .progress-bar {
            height: 8px;
            background-color: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress {
            height: 100%;
            background-color: var(--primary);
            width: 0;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-align: center;
        }

        .device-info {
            background-color: var(--bg-tertiary);
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            font-family: monospace;
            white-space: pre-wrap;
            overflow-x: auto;
        }

        .log-container {
            background-color: var(--bg-secondary);
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            padding: 15px;
            margin-top: auto;
            max-height: 200px;
            overflow-y: auto;
        }

        .log-title {
            font-size: 1rem;
            margin-bottom: 10px;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .log-title i {
            font-size: 1.1rem;
        }

        .log-content {
            font-family: monospace;
            font-size: 0.9rem;
            color: var(--text);
            white-space: pre-wrap;
            line-height: 1.5;
        }

        .log-entry {
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border);
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-time {
            color: var(--text-secondary);
            margin-right: 10px;
        }

        .log-message {
            color: var(--text);
        }

        .log-success {
            color: var(--secondary);
        }

        .log-error {
            color: var(--danger);
        }

        .log-warning {
            color: var(--warning);
        }

        .log-info {
            color: var(--primary);
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-connected {
            background-color: var(--secondary);
            animation: pulse 2s infinite;
        }

        .status-disconnected {
            background-color: var(--danger);
        }

        .status-connecting {
            background-color: var(--warning);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .rotate {
            animation: rotate 2s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        footer {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 30px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .card {
                padding: 15px;
            }
        }

        /* Animasi khusus */
        .floating {
            animation: floating 3s ease-in-out infinite;
        }

        @keyframes floating {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        .glow {
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { box-shadow: 0 0 5px rgba(66, 133, 244, 0.5); }
            to { box-shadow: 0 0 20px rgba(66, 133, 244, 0.8); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-microchip"></i>
                <span>ESP Firmware Flasher</span>
            </div>
            <button class="theme-toggle" id="themeToggle">
                <i class="fas fa-moon"></i>
            </button>
        </header>

        <div class="card fade-in">
            <h2 class="card-title">
                <i class="fas fa-plug"></i>
                Koneksi Perangkat
            </h2>
            <div class="form-group">
                <label for="portSelect">Port Serial</label>
                <select id="portSelect">
                    <option value="">Mencari port...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="baudSelect">Baud Rate</label>
                <select id="baudSelect">
                    <option value="115200">115200</option>
                    <option value="9600">9600</option>
                    <option value="19200">19200</option>
                    <option value="38400">38400</option>
                    <option value="57600">57600</option>
                    <option value="74880">74880</option>
                    <option value="230400">230400</option>
                    <option value="250000">250000</option>
                    <option value="460800">460800</option>
                    <option value="921600">921600</option>
                </select>
            </div>
            <div class="btn-group">
                <button id="connectBtn" class="btn btn-primary">
                    <i class="fas fa-link"></i> Sambungkan
                </button>
                <button id="disconnectBtn" class="btn btn-danger" disabled>
                    <i class="fas fa-unlink"></i> Putuskan
                </button>
                <button id="refreshPortsBtn" class="btn btn-secondary">
                    <i class="fas fa-sync-alt"></i> Segarkan Port
                </button>
            </div>
            <div id="deviceInfoContainer" class="device-info hidden">
                <div id="connectionStatus">
                    <span class="status-indicator status-disconnected"></span>
                    <span>Tidak terhubung</span>
                </div>
                <div id="deviceDetails"></div>
            </div>
        </div>

        <div class="card fade-in">
            <h2 class="card-title">
                <i class="fas fa-upload"></i>
                Upload Firmware
            </h2>
            <div class="form-group">
                <label for="firmwareFile">File Firmware (.bin)</label>
                <input type="file" id="firmwareFile" accept=".bin,.hex">
            </div>
            <div class="form-group">
                <label for="flashMode">Mode Flash</label>
                <select id="flashMode">
                    <option value="qio">QIO</option>
                    <option value="qout">QOUT</option>
                    <option value="dio">DIO</option>
                    <option value="dout">DOUT</option>
                </select>
            </div>
            <div class="form-group">
                <label for="flashSize">Ukuran Flash</label>
                <select id="flashSize">
                    <option value="4MB">4MB (FS:2MB OTA:~1019KB)</option>
                    <option value="2MB">2MB (FS:1MB OTA:~512KB)</option>
                    <option value="8MB">8MB (FS:3MB OTA:~1019KB)</option>
                    <option value="16MB">16MB (FS:12MB OTA:~1019KB)</option>
                    <option value="1MB">1MB (No OTA)</option>
                    <option value="512KB">512KB (No OTA)</option>
                    <option value="256KB">256KB (No OTA)</option>
                </select>
            </div>
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar">
                    <div class="progress" id="progressBar"></div>
                </div>
                <div class="progress-text" id="progressText">Mempersiapkan upload...</div>
            </div>
            <div class="btn-group">
                <button id="uploadBtn" class="btn btn-primary" disabled>
                    <i class="fas fa-upload"></i> Upload Firmware
                </button>
                <button id="rebootBtn" class="btn btn-secondary" disabled>
                    <i class="fas fa-power-off"></i> Reboot
                </button>
                <button id="factoryResetBtn" class="btn btn-danger">
                    <i class="fas fa-trash"></i> Reset Pabrik
                </button>
            </div>
        </div>

        <div class="log-container fade-in">
            <h3 class="log-title">
                <i class="fas fa-terminal"></i>
                Log Sistem
            </h3>
            <div class="log-content" id="logContent"></div>
        </div>
    </div>

    <footer>
        <p>ESP Firmware Flasher &copy; 2023 | Dibangun dengan <i class="fas fa-heart" style="color: var(--danger);"></i> untuk pengembangan ESP</p>
    </footer>

    <script>
        // Variabel global
        let serialPort = null;
        let reader = null;
        let writer = null;
        let isConnected = false;
        let currentTheme = localStorage.getItem('theme') || 'light';
        let deviceInfo = {};
        let isFlashing = false;

        // Elemen DOM
        const themeToggle = document.getElementById('themeToggle');
        const portSelect = document.getElementById('portSelect');
        const baudSelect = document.getElementById('baudSelect');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const refreshPortsBtn = document.getElementById('refreshPortsBtn');
        const uploadBtn = document.getElementById('uploadBtn');
        const rebootBtn = document.getElementById('rebootBtn');
        const factoryResetBtn = document.getElementById('factoryResetBtn');
        const firmwareFile = document.getElementById('firmwareFile');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const logContent = document.getElementById('logContent');
        const deviceInfoContainer = document.getElementById('deviceInfoContainer');
        const deviceDetails = document.getElementById('deviceDetails');
        const connectionStatus = document.getElementById('connectionStatus');
        const flashMode = document.getElementById('flashMode');
        const flashSize = document.getElementById('flashSize');

        // Inisialisasi tema
        function initTheme() {
            document.documentElement.setAttribute('data-theme', currentTheme);
            if (currentTheme === 'dark') {
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
            }
        }

        // Toggle tema
        function toggleTheme() {
            if (currentTheme === 'light') {
                currentTheme = 'dark';
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                currentTheme = 'light';
                themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
            }
            document.documentElement.setAttribute('data-theme', currentTheme);
            localStorage.setItem('theme', currentTheme);
        }

        // Tambah log
        function addLog(message, type = 'info') {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            
            const timeSpan = document.createElement('span');
            timeSpan.className = 'log-time';
            timeSpan.textContent = `[${timeString}]`;
            
            const messageSpan = document.createElement('span');
            messageSpan.className = 'log-message';
            messageSpan.textContent = message;
            
            logEntry.appendChild(timeSpan);
            logEntry.appendChild(messageSpan);
            logContent.appendChild(logEntry);
            
            // Scroll ke bawah
            logContent.scrollTop = logContent.scrollHeight;
        }

        // Deteksi port serial yang tersedia
        async function refreshSerialPorts() {
            try {
                portSelect.innerHTML = '<option value="">Mencari port...</option>';
                addLog('Mencari port serial yang tersedia...', 'info');
                
                if (!navigator.serial) {
                    throw new Error('Web Serial API tidak didukung di browser ini.');
                }
                
                const ports = await navigator.serial.getPorts();
                
                if (ports.length === 0) {
                    portSelect.innerHTML = '<option value="">Tidak ada port yang ditemukan</option>';
                    addLog('Tidak ada port serial yang ditemukan.', 'warning');
                    return;
                }
                
                portSelect.innerHTML = '<option value="">Pilih port...</option>';
                ports.forEach(port => {
                    const option = document.createElement('option');
                    option.value = port.getInfo().usbVendorId ? 
                        `${port.getInfo().usbVendorId}:${port.getInfo().usbProductId}` : 
                        port.getInfo().path || 'unknown';
                    option.textContent = port.getInfo().usbProductId ? 
                        `USB (${port.getInfo().usbProductId})` : 
                        port.getInfo().path || 'Port Serial';
                    portSelect.appendChild(option);
                });
                
                addLog(`Ditemukan ${ports.length} port serial.`, 'success');
            } catch (error) {
                addLog(`Gagal memuat port serial: ${error.message}`, 'error');
                portSelect.innerHTML = '<option value="">Error memuat port</option>';
            }
        }

        // Koneksi ke port serial
        async function connectToSerial() {
            const portValue = portSelect.value;
            const baudRate = parseInt(baudSelect.value);
            
            if (!portValue) {
                addLog('Silakan pilih port serial terlebih dahulu.', 'warning');
                return;
            }
            
            try {
                addLog(`Mencoba menghubungkan ke port dengan baud rate ${baudRate}...`, 'info');
                
                let port;
                const ports = await navigator.serial.getPorts();
                
                if (ports.length === 0) {
                    throw new Error('Tidak ada port yang tersedia.');
                }
                
                // Cari port yang sesuai
                port = ports.find(p => {
                    const info = p.getInfo();
                    return (info.usbVendorId ? 
                        `${info.usbVendorId}:${info.usbProductId}` : 
                        info.path || 'unknown') === portValue;
                });
                
                if (!port) {
                    throw new Error('Port tidak ditemukan.');
                }
                
                await port.open({ baudRate });
                
                serialPort = port;
                isConnected = true;
                
                reader = port.readable.getReader();
                writer = port.writable.getWriter();
                
                // Update UI
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                uploadBtn.disabled = false;
                rebootBtn.disabled = false;
                portSelect.disabled = true;
                baudSelect.disabled = true;
                
                // Update status koneksi
                connectionStatus.innerHTML = `
                    <span class="status-indicator status-connected"></span>
                    <span>Terhubung - Baud Rate: ${baudRate}</span>
                `;
                deviceInfoContainer.classList.remove('hidden');
                
                addLog(`Berhasil terhubung ke port serial dengan baud rate ${baudRate}.`, 'success');
                
                // Baca data dari port serial
                readSerialData();
                
                // Dapatkan info perangkat
                await getDeviceInfo();
                
            } catch (error) {
                addLog(`Gagal terhubung ke port serial: ${error.message}`, 'error');
                if (serialPort) {
                    try {
                        await serialPort.close();
                    } catch (e) {
                        addLog(`Error saat menutup port: ${e.message}`, 'error');
                    }
                    serialPort = null;
                }
                isConnected = false;
            }
        }

        // Baca data dari port serial
        async function readSerialData() {
            try {
                while (isConnected && reader) {
                    const { value, done } = await reader.read();
                    if (done) {
                        reader.releaseLock();
                        break;
                    }
                    
                    if (value) {
                        const text = new TextDecoder().decode(value);
                        addLog(`Perangkat: ${text.trim()}`, 'info');
                    }
                }
            } catch (error) {
                if (isConnected) {
                    addLog(`Error membaca data serial: ${error.message}`, 'error');
                }
            }
        }

        // Putuskan koneksi serial
        async function disconnectSerial() {
            if (!serialPort) return;
            
            try {
                addLog('Memutuskan koneksi serial...', 'info');
                
                if (reader) {
                    try {
                        await reader.cancel();
                    } catch (error) {
                        addLog(`Error saat membatalkan reader: ${error.message}`, 'error');
                    }
                    reader = null;
                }
                
                if (writer) {
                    try {
                        await writer.close();
                    } catch (error) {
                        addLog(`Error saat menutup writer: ${error.message}`, 'error');
                    }
                    writer = null;
                }
                
                await serialPort.close();
                serialPort = null;
                isConnected = false;
                
                // Update UI
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                uploadBtn.disabled = true;
                rebootBtn.disabled = true;
                portSelect.disabled = false;
                baudSelect.disabled = false;
                
                // Update status koneksi
                connectionStatus.innerHTML = `
                    <span class="status-indicator status-disconnected"></span>
                    <span>Tidak terhubung</span>
                `;
                deviceDetails.innerHTML = '';
                
                addLog('Koneksi serial berhasil diputuskan.', 'success');
            } catch (error) {
                addLog(`Gagal memutuskan koneksi serial: ${error.message}`, 'error');
            }
        }

        // Dapatkan info perangkat
        async function getDeviceInfo() {
            if (!serialPort || !writer) return;
            
            try {
                addLog('Mendapatkan informasi perangkat...', 'info');
                
                // Kirim perintah untuk mendapatkan info perangkat
                const command = new TextEncoder().encode('\n');
                await writer.write(command);
                
                // Simulasikan respon perangkat (dalam implementasi nyata, ini akan dibaca dari port serial)
                setTimeout(() => {
                    deviceInfo = {
                        chipType: 'ESP32',
                        macAddress: '24:0A:C4:12:34:56',
                        flashSize: '4MB',
                        firmwareVersion: 'v1.0.0',
                        sdkVersion: 'ESP-IDF v4.4',
                        freeHeap: '200KB',
                        sketchSize: '1.2MB'
                    };
                    
                    displayDeviceInfo();
                    addLog('Informasi perangkat berhasil diterima.', 'success');
                }, 1000);
                
            } catch (error) {
                addLog(`Gagal mendapatkan informasi perangkat: ${error.message}`, 'error');
            }
        }

        // Tampilkan info perangkat
        function displayDeviceInfo() {
            deviceDetails.innerHTML = `
                <div><strong>Tipe Chip:</strong> ${deviceInfo.chipType}</div>
                <div><strong>Alamat MAC:</strong> ${deviceInfo.macAddress}</div>
                <div><strong>Ukuran Flash:</strong> ${deviceInfo.flashSize}</div>
                <div><strong>Versi Firmware:</strong> ${deviceInfo.firmwareVersion}</div>
                <div><strong>Versi SDK:</strong> ${deviceInfo.sdkVersion}</div>
                <div><strong>Heap Tersedia:</strong> ${deviceInfo.freeHeap}</div>
                <div><strong>Ukuran Sketch:</strong> ${deviceInfo.sketchSize}</div>
            `;
        }

        // Upload firmware
        async function uploadFirmware() {
            if (!serialPort || !writer) {
                addLog('Tidak terhubung ke perangkat.', 'error');
                return;
            }
            
            const file = firmwareFile.files[0];
            if (!file) {
                addLog('Silakan pilih file firmware terlebih dahulu.', 'warning');
                return;
            }
            
            try {
                isFlashing = true;
                progressContainer.style.display = 'block';
                progressBar.style.width = '0%';
                progressText.textContent = 'Mempersiapkan upload...';
                
                addLog(`Memulai upload firmware: ${file.name}`, 'info');
                
                // Simulasikan proses upload
                const fileSize = file.size;
                const chunkSize = 1024; // 1KB per chunk
                const totalChunks = Math.ceil(fileSize / chunkSize);
                
                // Baca file sebagai array buffer
                const arrayBuffer = await file.arrayBuffer();
                
                // Kirim perintah flash mode dan size ke perangkat
                const flashModeValue = flashMode.value;
                const flashSizeValue = flashSize.value;
                
                addLog(`Mengatur mode flash: ${flashModeValue}, ukuran: ${flashSizeValue}`, 'info');
                
                // Proses upload dalam chunk
                for (let i = 0; i < totalChunks; i++) {
                    if (!isFlashing) break;
                    
                    const start = i * chunkSize;
                    const end = Math.min(start + chunkSize, fileSize);
                    const chunk = arrayBuffer.slice(start, end);
                    
                    // Kirim chunk ke perangkat (simulasi)
                    await new Promise(resolve => setTimeout(resolve, 50));
                    
                    // Update progress
                    const progress = Math.round(((i + 1) / totalChunks) * 100);
                    progressBar.style.width = `${progress}%`;
                    progressText.textContent = `Mengupload... ${progress}% (${i + 1}/${totalChunks} chunk)`;
                    
                    // Update setiap 5% atau chunk terakhir
                    if (progress % 5 === 0 || i === totalChunks - 1) {
                        addLog(`Progress upload: ${progress}%`, 'info');
                    }
                }
                
                if (isFlashing) {
                    progressText.textContent = 'Upload selesai! Memverifikasi...';
                    addLog('Upload firmware selesai. Memverifikasi...', 'success');
                    
                    // Simulasi verifikasi
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    progressText.textContent = 'Firmware berhasil diupload!';
                    addLog('Firmware berhasil diupload dan diverifikasi.', 'success');
                    
                    // Aktifkan tombol reboot
                    rebootBtn.disabled = false;
                    
                    // Auto-reboot setelah 3 detik
                    setTimeout(() => {
                        addLog('Memulai reboot otomatis perangkat...', 'info');
                        rebootDevice();
                    }, 3000);
                }
            } catch (error) {
                addLog(`Gagal mengupload firmware: ${error.message}`, 'error');
                progressText.textContent = 'Upload gagal!';
            } finally {
                isFlashing = false;
            }
        }

        // Reboot perangkat
        async function rebootDevice() {
            if (!serialPort || !writer) {
                addLog('Tidak terhubung ke perangkat.', 'error');
                return;
            }
            
            try {
                addLog('Mengirim perintah reboot ke perangkat...', 'info');
                
                // Kirim perintah reboot
                const command = new TextEncoder().encode('reboot\n');
                await writer.write(command);
                
                addLog('Perintah reboot berhasil dikirim. Perangkat akan restart...', 'success');
                
                // Putuskan koneksi
                await disconnectSerial();
                
                // Refresh port setelah beberapa detik
                setTimeout(() => {
                    refreshSerialPorts();
                    addLog('Silakan sambungkan kembali perangkat setelah reboot.', 'info');
                }, 3000);
                
            } catch (error) {
                addLog(`Gagal mengirim perintah reboot: ${error.message}`, 'error');
            }
        }

        // Reset pabrik
        async function factoryReset() {
            if (!confirm('Apakah Anda yakin ingin melakukan reset pabrik? Semua data akan dihapus.')) {
                return;
            }
            
            if (isConnected) {
                try {
                    addLog('Memulai reset pabrik...', 'warning');
                    
                    // Kirim perintah reset pabrik
                    const command = new TextEncoder().encode('factory_reset\n');
                    await writer.write(command);
                    
                    addLog('Perintah reset pabrik dikirim. Menghapus semua data...', 'warning');
                    
                    // Simulasi proses reset
                    progressContainer.style.display = 'block';
                    progressBar.style.width = '0%';
                    progressText.textContent = 'Memulai reset pabrik...';
                    
                    for (let i = 0; i <= 100; i += 10) {
                        await new Promise(resolve => setTimeout(resolve, 200));
                        progressBar.style.width = `${i}%`;
                        progressText.textContent = `Menghapus data... ${i}%`;
                    }
                    
                    addLog('Reset pabrik berhasil. Semua data telah dihapus.', 'success');
                    progressText.textContent = 'Reset pabrik berhasil!';
                    
                    // Auto-reboot setelah reset
                    setTimeout(() => {
                        addLog('Memulai reboot setelah reset pabrik...', 'info');
                        rebootDevice();
                    }, 2000);
                    
                } catch (error) {
                    addLog(`Gagal melakukan reset pabrik: ${error.message}`, 'error');
                    progressText.textContent = 'Reset pabrik gagal!';
                } finally {
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                    }, 3000);
                }
            } else {
                addLog('Tidak terhubung ke perangkat. Reset pabrik tidak dapat dilakukan.', 'error');
            }
        }

        // Event listeners
        themeToggle.addEventListener('click', toggleTheme);
        connectBtn.addEventListener('click', connectToSerial);
        disconnectBtn.addEventListener('click', disconnectSerial);
        refreshPortsBtn.addEventListener('click', refreshSerialPorts);
        uploadBtn.addEventListener('click', uploadFirmware);
        rebootBtn.addEventListener('click', rebootDevice);
        factoryResetBtn.addEventListener('click', factoryReset);
        firmwareFile.addEventListener('change', () => {
            if (firmwareFile.files.length > 0) {
                addLog(`File firmware dipilih: ${firmwareFile.files[0].name}`, 'info');
            }
        });

        // Inisialisasi
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            refreshSerialPorts();
            addLog('Aplikasi ESP Firmware Flasher siap digunakan.', 'success');
            
            // Periksa ketersediaan Web Serial API
            if (!navigator.serial) {
                addLog('PERINGATAN: Browser tidak mendukung Web Serial API. Aplikasi tidak akan berfungsi penuh.', 'error');
                addLog('Gunakan Chrome/Edge versi terbaru untuk pengalaman terbaik.', 'warning');
                
                // Nonaktifkan semua fungsi
                connectBtn.disabled = true;
                refreshPortsBtn.disabled = true;
                uploadBtn.disabled = true;
                rebootBtn.disabled = true;
                factoryResetBtn.disabled = true;
                
                portSelect.innerHTML = '<option value="">Web Serial API tidak didukung</option>';
            }
        });

        // Deteksi perubahan port serial (event tidak tersedia di Web Serial API, jadi kita polling)
        setInterval(async () => {
            if (!isConnected && navigator.serial) {
                const previousPorts = Array.from(portSelect.options)
                    .map(opt => opt.value)
                    .filter(val => val);
                
                const currentPorts = (await navigator.serial.getPorts())
                    .map(port => port.getInfo().usbVendorId ? 
                        `${port.getInfo().usbVendorId}:${port.getInfo().usbProductId}` : 
                        port.getInfo().path || 'unknown');
                
                if (previousPorts.length !== currentPorts.length || 
                    !previousPorts.every((val, idx) => val === currentPorts[idx])) {
                    refreshSerialPorts();
                }
            }
        }, 5000);
    </script>
</body>
</html>
